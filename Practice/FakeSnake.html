<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snake Game (No Input Lag + No Reversal)</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
      background: #111;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <script>
    const createEntity = components => ({ ...components });

    const movementSystem = entities =>
      entities.map(entity => {
        if (entity.type === "snake" && entity.body) {
          const newBody = [...entity.body];
          const head = { x: newBody[0].x + entity.direction.x, y: newBody[0].y + entity.direction.y };

          // Wrap around the canvas
          if (head.x < 0) head.x = 19;
          if (head.x >= 20) head.x = 0;
          if (head.y < 0) head.y = 19;
          if (head.y >= 20) head.y = 0;

          newBody.unshift(head);
          newBody.pop();
          return { ...entity, body: newBody };
        }
        return entity;
      });

    const renderSystem = (entities, canvas) => {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      entities.forEach(entity => {
        if (entity.type === "snake") {
          ctx.fillStyle = "lime";
          entity.body.forEach(segment => {
            ctx.fillRect(segment.x * 20, segment.y * 20, 20, 20);
          });
        }
      });
    };

    let entities = [
      createEntity({
        id: "snake",
        type: "snake",
        body: [{ x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 }],
        direction: { x: 1, y: 0 },
        alive: true
      })
    ];

    const canvasEl = document.getElementById("gameCanvas");

    // Track the last time a direction change was made
    let lastDirectionChangeTime = 0;
    const directionChangeCooldown = 500; // 0.5 seconds cooldown

    // Handle input with a cooldown to prevent rapid direction changes
    document.addEventListener("keydown", e => {
      const key = e.key;
      const currentDirection = entities[0].direction;
      const now = Date.now();

      // Check if enough time has passed since the last direction change
      if (now - lastDirectionChangeTime >= directionChangeCooldown) {
        let newDirection = null;

        // Calculate the new direction based on the key pressed
        if (key === "ArrowUp" && currentDirection.y === 0) newDirection = { x: 0, y: -1 };
        if (key === "ArrowDown" && currentDirection.y === 0) newDirection = { x: 0, y: 1 };
        if (key === "ArrowLeft" && currentDirection.x === 0) newDirection = { x: -1, y: 0 };
        if (key === "ArrowRight" && currentDirection.x === 0) newDirection = { x: 1, y: 0 };

        // Apply the new direction if it's valid
        if (newDirection) {
          entities[0].direction = newDirection;
          lastDirectionChangeTime = now; // Update the last direction change time
        }
      }
    });

    function gameLoop() {
      if (entities[0].alive) {
        // Move the snake
        entities = movementSystem(entities);

        // Render the snake
        renderSystem(entities, canvasEl);

        // Slow down the game loop
        setTimeout(gameLoop, 200); // 200ms delay for slower movement
      }
    }

    gameLoop();
  </script>
</body>
</html>